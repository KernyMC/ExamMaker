<!DOCTYPE html>
<html>
<head>
   <title>Cuestionario Moodle</title>
   <link rel="stylesheet" type="text/css" href="styles.css">
</head>
<body>
   <div class="button-section">
       <button id="loadDefaultExam" class="load-button default-exam">Cargar Examen Normal</button>
       <button id="loadRandomExam" class="load-button random-exam">üé≤ Cargar Examen Aleatorio</button>
       <button id="chooseDifficulty" class="load-button difficulty-exam">Escoger Dificultad</button>
   </div>
   <div id="difficultySection" style="display:none; text-align:center; margin:10px;">
    <button class="load-button difficulty-button" onclick="setDifficultySelected(this); loadQuestionsByDifficulty(1)">Ultraf√°cil </button>
    <button class="load-button difficulty-button" onclick="setDifficultySelected(this); loadQuestionsByDifficulty(20)">F√°cil</button>
    <button class="load-button difficulty-button" onclick="setDifficultySelected(this); loadQuestionsByDifficulty(80)">Medio</button>
    <button class="load-button difficulty-button" onclick="setDifficultySelected(this); loadQuestionsByDifficulty(260)">Dif√≠cil</button>
    <button class="load-button difficulty-button" onclick="setDifficultySelected(this); loadQuestionsByDifficulty('all')">Ultrahardcore</button>
   </div>
   <div class="upload-section">
       <input type="file" id="fileInput" accept=".txt,.docx">
       <p>Arrastra tu archivo o haz clic para seleccionarlo</p>
   </div>
   <div id="score" class="score"></div>
   <div id="questionsContainer"></div>

   <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.0/mammoth.browser.min.js"></script>
   <script>
       let totalQuestions = 0;
       let correctAnswers = 0;
       let allQuestions = [];
       // Almacena las preguntas actualmente mostradas (para checkAnswer).
       let displayedQuestions = [];

       window.onload = loadDefaultExam;
       document.getElementById('loadDefaultExam').addEventListener('click', loadDefaultExam);
       document.getElementById('loadRandomExam').addEventListener('click', loadRandomExam);
       document.getElementById('chooseDifficulty').addEventListener('click', toggleDifficultySection);

       document.getElementById('fileInput').addEventListener('change', handleFileSelect);

       function toggleDifficultySection() {
           const sec = document.getElementById('difficultySection');
           sec.style.display = (sec.style.display === 'none') ? 'block' : 'none';
       }

       function setDifficultySelected(button) {
           document.querySelectorAll('.difficulty-button').forEach(b => b.classList.remove('selected'));
           button.classList.add('selected');
       }

       function loadDefaultExam() {
           fetch('examen/examenFinal.txt')
               .then(response => response.text())
               .then(text => {
                   allQuestions = parseQuestions(text);
                   displayQuestions(allQuestions, false);
               })
               .catch(error => console.error('Error:', error));
       }

       function loadRandomExam() {
           fetch('examen/examenFinal.txt')
               .then(response => response.text())
               .then(text => {
                   allQuestions = parseQuestions(text);
                   displayQuestions(allQuestions, true);
               })
               .catch(error => console.error('Error:', error));
       }

       function handleFileSelect(event) {
           const file = event.target.files[0];
           document.getElementById('questionsContainer').innerHTML = '';
           totalQuestions = 0;
           correctAnswers = 0;
           updateScore();
           
           if (file.name.endsWith('.docx')) {
               const reader = new FileReader();
               reader.onload = function(e) {
                   mammoth.extractRawText({arrayBuffer: e.target.result})
                       .then(result => {
                           allQuestions = parseQuestions(result.value);
                           displayQuestions(allQuestions, false);
                       });
               };
               reader.readAsArrayBuffer(file);
           } else {
               const reader = new FileReader();
               reader.onload = function(e) {
                   allQuestions = parseQuestions(e.target.result);
                   displayQuestions(allQuestions, false);
               };
               reader.readAsText(file);
           }
       }

       function loadQuestionsByDifficulty(count) {
           document.getElementById('questionsContainer').innerHTML = '';
           if (!allQuestions.length) {
               fetch('examen/examenFinal.txt')
                   .then(response => response.text())
                   .then(text => {
                       allQuestions = parseQuestions(text);
                       showSubset(allQuestions, count);
                   });
           } else {
               showSubset(allQuestions, count);
           }
       }

       function showSubset(questions, count) {
           const shuffled = shuffleArray([...questions]);
           let subset = [];
           if (count === 'all') {
               subset = shuffled;
           } else {
               subset = shuffled.slice(0, count);
           }
           displayQuestions(subset, true);
       }

       // En esta funci√≥n, guardamos en question.correctAnswer
       // el texto correcto en lugar de la letra (A, B, C, D).
       function parseQuestions(text) {
           const questions = [];
           const lines = text.split('\n');
           let question = null;

           lines.forEach(line => {
               line = line.trim();
               if (line.length === 0) return;
               if (!question) {
                   question = { text: escapeHtml(line), options: [], correctAnswer: '' };
               } else if (line.match(/^[A-D][.)]\s+/)) {
                   question.options.push(escapeHtml(line.substring(3).trim()));
               } else if (line.match(/^ANSWER:\s+[A-D]/)) {
                   const letter = line.substring(8).trim();
                   // Calcula √≠ndice en options (A=0, B=1, etc.)
                   const letterIndex = letter.charCodeAt(0) - 65;
                   // Guarda el texto completo de la respuesta correcta.
                   question.correctAnswer = question.options[letterIndex] || '';
                   questions.push(question);
                   question = null;
               } else {
                   question.text += ' ' + escapeHtml(line);
               }
           });

           return questions;
       }

       // Guardamos las preguntas que se muestran en una variable global (displayedQuestions)
       // para que coincida el √≠ndice a la hora de verificar la respuesta.
       function displayQuestions(questions, randomize) {
           displayedQuestions = questions;
           totalQuestions = questions.length;
           correctAnswers = 0;
           updateScore();

           const container = document.getElementById('questionsContainer');
           container.innerHTML = '';

           if (randomize) {
               // Mezclar opciones de cada pregunta.
               questions.forEach(q => {
                   q.options = shuffleArray(q.options);
               });
           }

           questions.forEach((q, index) => {
               const div = document.createElement('div');
               div.className = 'question';
               // Para evitar problemas con comillas, usaremos valor = la opci√≥n entera
               // y compararemos en checkAnswer con q.correctAnswer.
               div.innerHTML = `
                   <div class="question-number">Pregunta ${index + 1}</div>
                   <div class="question-text">${q.text}</div>
                   <div class="options">
                       ${q.options.map((opt, i) => `
                           <div class="option">
                               <input type="radio" id="q${index}opt${i}" name="q${index}" 
                                      value="${opt}" 
                                      onclick="checkAnswer(${index}, this.value)">
                               <label for="q${index}opt${i}">${String.fromCharCode(65 + i)}. ${opt}</label>
                           </div>
                       `).join('')}
                   </div>
                   <div class="feedback"></div>
                   <div class="correctAnswer" style="display:none">
                       <hr>
                       <strong>Respuesta correcta:</strong> ${q.correctAnswer}
                   </div>
               `;
               container.appendChild(div);
           });
       }

       // Aqu√≠ comparamos el valor seleccionado (texto) con la respuesta correcta (texto).
       function checkAnswer(questionIndex, selectedValue) {
           const questionDiv = document.getElementsByClassName('question')[questionIndex];
           const feedbackDiv = questionDiv.querySelector('.feedback');
           const correctAnswerDiv = questionDiv.querySelector('.correctAnswer');

           feedbackDiv.style.display = 'block';
           correctAnswerDiv.style.display = 'block';

           // Obtenemos la pregunta desde displayedQuestions
           const question = displayedQuestions[questionIndex];
           if (selectedValue === question.correctAnswer) {
               questionDiv.className = 'question correct';
               feedbackDiv.innerHTML = '‚úì ¬°Correcto!';
               feedbackDiv.style.color = '#3c763d';
               correctAnswers++;
           } else {
               questionDiv.className = 'question incorrect';
               feedbackDiv.innerHTML = '‚úó Incorrecto';
               feedbackDiv.style.color = '#a94442';
           }
           updateScore();
       }

       // Se actualiza la calificaci√≥n en pantalla.
       function updateScore() {
           const scoreDiv = document.getElementById('score');
           if (totalQuestions > 0) {
               const percentage = Math.round((correctAnswers / totalQuestions) * 100);
               scoreDiv.innerHTML = `
                   Calificaci√≥n: ${correctAnswers}/${totalQuestions} (${percentage}%)
                   ${percentage >= 60 ? '‚úì Aprobado' : '‚úó No aprobado'}
               `;
           }
       }

       // Mezcla los elementos de un array (Fisher-Yates).
       function shuffleArray(array) {
           for (let i = array.length - 1; i > 0; i--) {
               const j = Math.floor(Math.random() * (i + 1));
               [array[i], array[j]] = [array[j], array[i]];
           }
           return array;
       }

       // Escapa caracteres especiales para que se muestren correctamente.
       function escapeHtml(text) {
           const map = {
               '&': '&amp;',
               '<': '&lt;',
               '>': '&gt;',
               '"': '&quot;',
               "'": '&#039;'
           };
           return text.replace(/[&<>"']/g, m => map[m]);
       }
   </script>
</body>
</html>