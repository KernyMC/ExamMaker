<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exam Maker</title>
    <!-- Google Fonts: Roboto -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap">
    <!-- Hoja de estilos CSS -->
    <link rel="stylesheet" type="text/css" href="styles.css">
    <!-- Iconos (opcional, para mejor estética) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <!-- Encabezado -->
    <header>
        <h1>Exam Maker</h1>
    </header>

    <!-- Contenido Principal -->
    <main>
        <!-- Sección de Botones Principales -->
        <section class="button-section">
            <button id="loadDefaultExam" class="load-button default-exam">Cargar Examen Normal</button>
            <button id="loadRandomExam" class="load-button random-exam">🎲 Cargar Examen Aleatorio</button>
            <button id="chooseDifficulty" class="load-button difficulty-exam">Escoger Dificultad</button>
            <!-- Nuevo Botón Añadido -->
            <button id="loadOldExams" class="load-button old-exam">EXAMENES VIEJOS</button>
        </section>

        <!-- Sección de Dificultad (Desplegable) -->
        <section id="difficultySection" class="difficulty-section">
            <button class="load-button difficulty-button ultrafacil" 
                    onclick="setDifficultySelected(this); loadQuestionsByDifficulty(1)">Ultrafácil
            </button>
            <button class="load-button difficulty-button facil" 
                    onclick="setDifficultySelected(this); loadQuestionsByDifficulty(20)">Fácil
            </button>
            <button class="load-button difficulty-button medio" 
                    onclick="setDifficultySelected(this); loadQuestionsByDifficulty(80)">Medio
            </button>
            <button class="load-button difficulty-button dificil" 
                    onclick="setDifficultySelected(this); loadQuestionsByDifficulty(260)">Difícil
            </button>
            <button class="load-button difficulty-button ultrahardcore" 
                    onclick="setDifficultySelected(this); loadQuestionsByDifficulty('all')">Ultrahardcore
            </button>
        </section>

        <!-- Sección de Subida de Archivos -->
        <section class="upload-section" onclick="document.getElementById('fileInput').click();">
            <input type="file" id="fileInput" accept=".txt,.docx" hidden>
            <label for="fileInput" class="upload-label">
                <i class="fas fa-upload upload-icon"></i>
                <span>Arrastra tu archivo o haz clic para seleccionarlo</span>
            </label>
            <!-- Guía sobre Formato Aiken -->
            <div class="aiken-guide">
                <h2>¿Cómo preparar tu archivo en formato Aiken?</h2>
                <p>Para subir tus preguntas, asegúrate de que tu archivo sea un <strong>.txt</strong> y siga el <strong>formato Aiken</strong>. A continuación, te mostramos un ejemplo:</p>
                <pre>
¿Quién escribió "Cien años de soledad"?
A. Gabriel García Márquez
B. Mario Vargas Llosa
C. Isabel Allende
D. Julio Cortázar
ANSWER: A
                </pre>
                <p>Puedes seguir esta estructura para todas tus preguntas. Asegúrate de indicar correctamente la respuesta correcta con <code>ANSWER: </code> seguido de la letra correspondiente.</p>
            </div>
        </section>

        <!-- Sección de Calificación -->
        <section id="score" class="score"></section>

        <!-- Contenedor de Preguntas (Estilo Moodle, mostrando solo 1 a la vez) -->
        <section id="questionsContainer" class="questions-container">
            <!-- Contenedor para la Pregunta Actual -->
            <div id="currentQuestion" class="question"></div>

            <!-- Navegador de Preguntas (Botones numerados) -->
            <div id="questionNavigator" class="question-navigator"></div>
        </section>
    </main>

    <!-- Burbuja de Puntuación Estilo Messenger -->
    <div id="scoreBubble">
        <div class="bubble-content">
            <div class="icon-count">
                <i class="fas fa-check-circle correct-icon"></i>
                <span id="correctCount">0</span>
            </div>
            <div class="icon-count">
                <i class="fas fa-times-circle incorrect-icon"></i>
                <span id="incorrectCount">0</span>
            </div>
        </div>
    </div>

    <!-- Pie de Página -->
    <footer>
        <div class="footer-content">
            <p>Desarrollado por <strong>Kevinsaurio</strong> &copy; 2025</p>
        </div>
    </footer>

    <!-- Librerías y Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.0/mammoth.browser.min.js"></script>
    <script>
        let totalQuestions = 0;
        let correctAnswers = 0;
        let allQuestions = [];
        // Almacena las preguntas mostradas (para checkAnswer).
        let displayedQuestions = [];
        // Índice de la pregunta actual
        let currentQuestionIndex = 0;

        // Al cargar la ventana, por defecto: Examen Normal
        window.onload = loadDefaultExam;

        // Asignar eventos a los botones principales
        document.getElementById('loadDefaultExam').addEventListener('click', loadDefaultExam);
        document.getElementById('loadRandomExam').addEventListener('click', loadRandomExam);
        document.getElementById('chooseDifficulty').addEventListener('click', toggleDifficultySection);
        document.getElementById('loadOldExams').addEventListener('click', loadOldExams);

        // Evento al subir archivo
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);

        /* ========== MOSTRAR / OCULTAR SECCIÓN DE DIFICULTAD ========== */
        function toggleDifficultySection() {
            const sec = document.getElementById('difficultySection');
            sec.style.display = (sec.style.display === 'none' || sec.style.display === '') ? 'block' : 'none';
        }
        function setDifficultySelected(button) {
            document.querySelectorAll('.difficulty-button').forEach(b => b.classList.remove('selected'));
            button.classList.add('selected');
        }

        /* ========== CARGAS DE EXÁMENES ========== */
        function loadDefaultExam() {
            fetch('examen/examenFinal.txt')
                .then(response => response.text())
                .then(text => {
                    allQuestions = parseQuestions(text);
                    displayQuestions(allQuestions, false);
                })
                .catch(error => console.error('Error:', error));
        }

        function loadRandomExam() {
            fetch('examen/examenFinal.txt')
                .then(response => response.text())
                .then(text => {
                    allQuestions = parseQuestions(text);
                    displayQuestions(allQuestions, true); // Aleatorio
                })
                .catch(error => console.error('Error:', error));
        }

        function loadOldExams() {
            fetch('examen/union1.txt')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('No se pudo cargar el archivo union1.txt');
                    }
                    return response.text();
                })
                .then(text => {
                    allQuestions = parseQuestions(text);
                    displayQuestions(allQuestions, false);
                })
                .catch(error => {
                    console.error('Error al cargar EXAMENES VIEJOS:', error);
                    alert('Hubo un problema al cargar EXAMENES VIEJOS. Por favor, inténtalo de nuevo.');
                });
        }

        // Al subir un archivo
        function handleFileSelect(event) {
            const file = event.target.files[0];
            resetUI();

            if (file) {
                if (file.name.endsWith('.docx')) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        mammoth.extractRawText({arrayBuffer: e.target.result})
                            .then(result => {
                                allQuestions = parseQuestions(result.value);
                                displayQuestions(allQuestions, false);
                            });
                    };
                    reader.readAsArrayBuffer(file);
                } else {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        allQuestions = parseQuestions(e.target.result);
                        displayQuestions(allQuestions, false);
                    };
                    reader.readAsText(file, 'UTF-8');
                }
            }
        }

        /* ========== CARGAR POR DIFICULTAD ========== */
        function loadQuestionsByDifficulty(count) {
            resetUI();
            if (!allQuestions.length) {
                // Si no hay preguntas, cargamos examenFinal.txt
                fetch('examen/examenFinal.txt')
                    .then(response => response.text())
                    .then(text => {
                        allQuestions = parseQuestions(text);
                        showSubset(allQuestions, count);
                    });
            } else {
                showSubset(allQuestions, count);
            }
        }
        function showSubset(questions, count) {
            const shuffled = shuffleArray([...questions]);
            let subset = [];
            if (count === 'all') {
                subset = shuffled;
            } else {
                subset = shuffled.slice(0, count);
            }
            displayQuestions(subset, true);
        }

        /* ========== PARSEAR PREGUNTAS (FORMATO AIKEN) ========== */
        function parseQuestions(text) {
            const questions = [];
            const lines = text.split('\n');
            let question = null;

            lines.forEach(line => {
                line = line.trim();
                if (line.length === 0) return;
                
                if (!question) {
                    question = { 
                        text: line, 
                        options: [], 
                        correctAnswer: '', 
                        answered: false, 
                        selectedAnswer: null, 
                        isCorrect: false 
                    };
                } else if (line.match(/^[A-H][.)]\s+/)) {
                    question.options.push(line.substring(3).trim());
                } else if (line.match(/^ANSWER:\s+[A-D]/)) {
                    const letter = line.substring(8).trim().toUpperCase();
                    const letterIndex = letter.charCodeAt(0) - 65;
                    question.correctAnswer = question.options[letterIndex] || '';
                    questions.push(question);
                    question = null;
                } else {
                    question.text += ' ' + line;
                }
            });

            return questions;
        }

        /* ========== MOSTRAR PREGUNTAS (MODO MOODLE) ========== */
        function displayQuestions(questions, randomize) {
            displayedQuestions = questions;
            totalQuestions = questions.length;
            correctAnswers = 0;

            if (randomize) {
                // Mezclar opciones de cada pregunta
                displayedQuestions.forEach(q => {
                    q.options = shuffleArray(q.options);
                });
            }

            // Empezamos con la primera pregunta
            currentQuestionIndex = 0;

            // Mostrar la primera pregunta
            displayCurrentQuestion();
            // Armar el navegador de preguntas
            setupQuestionNavigator();
            // Actualizar calificación
            updateScore();
        }

        /* ========== MOSTRAR PREGUNTA ACTUAL ========== */
        function displayCurrentQuestion() {
            const questionDiv = document.getElementById('currentQuestion');
            questionDiv.innerHTML = '';

            if (currentQuestionIndex < 0 || currentQuestionIndex >= displayedQuestions.length) {
                questionDiv.innerHTML = '<p>No hay preguntas para mostrar.</p>';
                return;
            }

            const q = displayedQuestions[currentQuestionIndex];

            // Contenedor de la pregunta
            const container = document.createElement('div');
            container.className = 'question';

            // Número de pregunta
            const questionNumber = document.createElement('div');
            questionNumber.className = 'question-number';
            questionNumber.textContent = `Pregunta ${currentQuestionIndex + 1} de ${displayedQuestions.length}`;

            // Texto de la pregunta
            const questionText = document.createElement('div');
            questionText.className = 'question-text';
            questionText.textContent = q.text;

            // Opciones
            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'options';

            q.options.forEach((opt, i) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'option';

                const radioInput = document.createElement('input');
                radioInput.type = 'radio';
                radioInput.id = `q${currentQuestionIndex}opt${i}`;
                radioInput.name = `q${currentQuestionIndex}`;
                radioInput.value = opt;

                // Al hacer clic, verificamos la respuesta
                radioInput.onclick = () => checkAnswer(currentQuestionIndex, opt);

                // Si la pregunta ya fue respondida antes
                if (q.answered) {
                    radioInput.disabled = true;
                    if (opt === q.selectedAnswer) {
                        radioInput.checked = true;
                    }
                }

                const label = document.createElement('label');
                label.htmlFor = `q${currentQuestionIndex}opt${i}`;
                label.textContent = `${String.fromCharCode(65 + i)}. ${opt}`;

                optionDiv.appendChild(radioInput);
                optionDiv.appendChild(label);
                optionsDiv.appendChild(optionDiv);
            });

            // Feedback
            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = 'feedback';

            // Respuesta Correcta
            const correctAnswerDiv = document.createElement('div');
            correctAnswerDiv.className = 'correctAnswer';
            correctAnswerDiv.innerHTML = `<hr><strong>Respuesta correcta:</strong> ${q.correctAnswer}`;

            // Si la pregunta ya fue respondida
            if (q.answered) {
                feedbackDiv.style.display = 'block';
                correctAnswerDiv.style.display = 'block';
                if (q.isCorrect) {
                    container.classList.add('correct');
                    feedbackDiv.textContent = '✓ ¡Correcto!';
                    feedbackDiv.style.color = '#d4edda';
                } else {
                    container.classList.add('incorrect');
                    feedbackDiv.textContent = '✗ Incorrecto';
                    feedbackDiv.style.color = '#f8d7da';
                }
            }

            // Controles de Navegación dentro de la pregunta
            const navControls = document.createElement('div');
            navControls.className = 'navigation-controls-inline';

            // Botón Anterior
            const prevButton = document.createElement('button');
            prevButton.className = 'nav-button';
            prevButton.textContent = 'Anterior';
            prevButton.onclick = prevQuestion;
            prevButton.disabled = (currentQuestionIndex === 0);

            // Botón Siguiente
            const nextButton = document.createElement('button');
            nextButton.className = 'nav-button';
            nextButton.textContent = 'Siguiente';
            nextButton.onclick = nextQuestion;
            nextButton.disabled = (currentQuestionIndex === displayedQuestions.length - 1);

            navControls.appendChild(prevButton);
            navControls.appendChild(nextButton);

            // Añadimos todo al contenedor
            container.appendChild(questionNumber);
            container.appendChild(questionText);
            container.appendChild(optionsDiv);
            container.appendChild(feedbackDiv);
            container.appendChild(correctAnswerDiv);
            container.appendChild(navControls);

            questionDiv.appendChild(container);

            // Marcar en el navegador de preguntas la activa
            highlightNavigator(currentQuestionIndex);
        }

        /* ========== NAVEGADOR DE PREGUNTAS ========== */
        function setupQuestionNavigator() {
            const navigatorDiv = document.getElementById('questionNavigator');
            navigatorDiv.innerHTML = '';

            displayedQuestions.forEach((q, index) => {
                const btn = document.createElement('button');
                btn.className = 'nav-item';
                btn.textContent = index + 1;
                btn.onclick = () => goToQuestion(index);

                // Si está respondida, coloreamos
                if (q.answered) {
                    btn.classList.add(q.isCorrect ? 'answered-correct' : 'answered-incorrect');
                }

                navigatorDiv.appendChild(btn);
            });
        }

        // Marcar la pregunta actual (active) en el navegador
        function highlightNavigator(index) {
            const allNavItems = document.querySelectorAll('.nav-item');
            // Quitar .active de todos
            allNavItems.forEach(item => item.classList.remove('active'));
            // Agregar .active al item actual
            if (allNavItems[index]) {
                allNavItems[index].classList.add('active');
            }
        }

        /* ========== NAVEGACIÓN ENTRE PREGUNTAS ========== */
        function goToQuestion(index) {
            currentQuestionIndex = index;
            displayCurrentQuestion();
        }
        function prevQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayCurrentQuestion();
            }
        }
        function nextQuestion() {
            if (currentQuestionIndex < displayedQuestions.length - 1) {
                currentQuestionIndex++;
                displayCurrentQuestion();
            }
        }

        /* ========== VERIFICAR RESPUESTA ========== */
        function checkAnswer(questionIndex, selectedValue) {
            const question = displayedQuestions[questionIndex];
            if (question.answered) return;

            question.answered = true;
            question.selectedAnswer = selectedValue;
            question.isCorrect = (
                selectedValue.trim().toLowerCase() === question.correctAnswer.trim().toLowerCase()
            );

            if (question.isCorrect) {
                correctAnswers++;
            }
            displayCurrentQuestion();
            updateScore();
            setupQuestionNavigator();
        }

        /* ========== ACTUALIZAR CALIFICACIÓN ========== */
        function updateScore() {
            const scoreDiv = document.getElementById('score');
            if (displayedQuestions.length > 0) {
                const percentage = Math.round((correctAnswers / displayedQuestions.length) * 100);
                scoreDiv.innerHTML = `
                    Calificación: ${correctAnswers}/${displayedQuestions.length} (${percentage}%)
                    ${
                      percentage >= 60
                        ? '<span class="approved">✓ Aprobado</span>'
                        : '<span class="not-approved">✗ No aprobado</span>'
                    }
                `;
            } else {
                scoreDiv.innerHTML = '';
            }

            // Actualizar la burbuja de puntuación
            document.getElementById('correctCount').textContent = correctAnswers;
            document.getElementById('incorrectCount').textContent = displayedQuestions.length - correctAnswers;
        }

        /* ========== RESETEAR UI ========== */
        function resetUI() {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = `
                <div id="currentQuestion" class="question"></div>
                <div id="questionNavigator" class="question-navigator"></div>
            `;
            totalQuestions = 0;
            correctAnswers = 0;
            displayedQuestions = [];
            currentQuestionIndex = 0;
            updateScore();
        }

        /* ========== FUNCIÓN AUXILIAR: Shuffle Array ========== */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }
    </script>
</body>
</html>
